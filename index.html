<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#f2f2f7" />
    <link rel="apple-touch-icon" href="icon.png" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>MyKeys 安全密码本</title>
    <style>
      :root {
        /* iOS System Colors */
        --ios-bg: #f2f2f7;
        --ios-surface: #ffffff;
        --ios-blue: #007aff;
        --ios-red: #ff3b30;
        --ios-text-primary: #000000;
        --ios-text-secondary: rgba(60, 60, 67, 0.6);
        --ios-separator: rgba(60, 60, 67, 0.18);
        --radius-group: 10px;
        --radius-input: 10px;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        background-color: #000;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Helvetica Neue", sans-serif;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      /* 设备外壳 */
      #device-frame {
        width: 393px;
        height: 852px;
        background-color: var(--ios-bg);
        border-radius: 50px;
        box-shadow: 0 0 0 12px #2c2c2e, 0 0 0 13px #000,
          0 30px 60px rgba(0, 0, 0, 0.6);
        position: relative;
        overflow: hidden;
        color: var(--ios-text-primary);
        display: flex;
        flex-direction: column;
      }

      .app-container {
        flex: 1;
        overflow-y: auto;
        position: relative;
        scroll-behavior: smooth;
        padding-bottom: calc(90px + env(safe-area-inset-bottom));
        overscroll-behavior-y: contain;
      }

      .app-container::-webkit-scrollbar,
      .modal-body::-webkit-scrollbar {
        width: 0px;
        display: none;
      }

      .hidden {
        display: none !important;
      }

      /* --- 动画过渡类 --- */
      .anim-view {
        transition: opacity 0.4s cubic-bezier(0.32, 0.72, 0, 1),
          transform 0.4s cubic-bezier(0.32, 0.72, 0, 1), filter 0.3s ease;
        opacity: 1;
        transform: scale(1);
        filter: blur(0);
        width: 100%;
      }

      .view-hidden-before {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
        position: absolute; /* 防止占据空间导致布局跳动 */
        top: 0;
        left: 0;
      }

      .view-hidden-after {
        opacity: 0;
        transform: scale(1.05);
        pointer-events: none;
        filter: blur(10px);
      }

      /* --- 导航栏 --- */
      .nav-bar {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: rgba(242, 242, 247, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
        padding-top: calc(env(safe-area-inset-top) + 10px);
        padding-left: calc(env(safe-area-inset-left) + 16px);
        padding-right: calc(env(safe-area-inset-right) + 16px);
        height: auto;
        min-height: 80px;
      }

      .nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        height: 44px;
      }

      .nav-title {
        font-size: 34px;
        font-weight: 700;
        letter-spacing: -0.5px;
        margin: 0;
      }

      /* --- 搜索栏 --- */
      .search-container {
        position: relative;
        margin-bottom: 10px;
      }
      .search-input {
        width: 100%;
        height: 36px;
        background-color: rgba(118, 118, 128, 0.12);
        border-radius: 10px;
        border: none;
        padding: 0 15px;
        font-size: 17px;
        text-align: left;
      }
      .search-input:focus {
        outline: none;
        background-color: rgba(118, 118, 128, 0.18);
      }

      /* --- 下拉菜单核心样式 --- */
      .custom-select-wrapper {
        position: relative;
        width: 100%;
        z-index: 1;
      }

      .custom-select-trigger {
        background-color: rgba(118, 118, 128, 0.12);
        border-radius: 10px;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
        min-height: 36px;
      }
      .custom-select-trigger:active {
        background-color: rgba(118, 118, 128, 0.2);
      }

      .form-select .custom-select-trigger {
        background-color: transparent;
        padding: 0;
        justify-content: flex-end;
        gap: 8px;
        height: 100%;
        width: 100%;
      }

      .trigger-text {
        font-size: 14px;
        color: var(--ios-blue);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }
      .form-select .trigger-text {
        color: var(--ios-text-secondary);
        font-size: 17px;
        font-weight: 400;
      }
      .form-select.has-value .trigger-text {
        color: #000;
      }

      .trigger-icon {
        width: 12px;
        height: 12px;
        stroke: var(--ios-blue);
        stroke-width: 2.5;
        fill: none;
        flex-shrink: 0;
      }
      .form-select .trigger-icon {
        stroke: #c7c7cc;
        stroke-width: 2;
      }
      .custom-select-wrapper.open .trigger-icon {
        transform: rotate(180deg);
      }

      .custom-dropdown-menu {
        position: absolute;
        top: 45px;
        right: 0;
        width: 200px;
        background-color: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3),
          0 0 0 0.5px rgba(0, 0, 0, 0.1);
        padding: 6px;
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: 2px;
        max-height: 250px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        touch-action: pan-y;

        opacity: 0;
        visibility: hidden;
        transform: scale(0.95) translateY(-10px);
        transform-origin: top right;
        transition: all 0.2s cubic-bezier(0.32, 0.72, 0, 1);
      }

      .form-select .custom-dropdown-menu {
        top: 35px;
        right: -10px;
        width: 220px;
      }

      .custom-select-wrapper.open .custom-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: scale(1) translateY(0);
      }

      .custom-select-wrapper.open {
        z-index: 202 !important;
      }

      .custom-option {
        padding: 12px;
        font-size: 15px;
        color: #000;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        user-select: none;
      }
      .custom-option:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }
      .custom-option:active {
        background-color: rgba(0, 0, 0, 0.1);
      }
      .custom-option.selected {
        background-color: white;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .check-icon {
        opacity: 0;
        color: var(--ios-blue);
        font-weight: bold;
      }
      .custom-option.selected .check-icon {
        opacity: 1;
      }

      /* --- 列表样式 --- */
      .content-area {
        padding: 10px 16px 20px 16px;
      }

      .list-group {
        background-color: var(--ios-surface);
        border-radius: var(--radius-group);
        overflow: hidden;
        margin-bottom: 16px;
      }

      .list-row {
        display: flex;
        align-items: center;
        min-height: 50px;
        padding-left: 16px;
        background: var(--ios-surface);
        transition: background-color 0.2s;
        cursor: pointer;
      }
      .list-row:active {
        background-color: #e5e5ea;
      }

      .list-content {
        flex: 1;
        padding-right: 16px;
        padding-top: 10px;
        padding-bottom: 10px;
        border-bottom: 0.5px solid var(--ios-separator);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .list-row:last-child .list-content {
        border-bottom: none;
      }

      .row-main {
        display: flex;
        flex-direction: column;
        gap: 3px;
        overflow: hidden;
      }
      .row-title {
        font-size: 17px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .row-subtitle {
        font-size: 14px;
        color: var(--ios-text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tag-pill {
        font-size: 12px;
        color: var(--ios-text-secondary);
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 8px;
        border-radius: 6px;
        flex-shrink: 0;
        margin-left: 8px;
      }

      .copy-btn {
        background-color: rgba(0, 122, 255, 0.1);
        color: var(--ios-blue);
        border: none;
        padding: 6px 12px;
        border-radius: 14px;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .copy-btn:active {
        background-color: rgba(0, 122, 255, 0.2);
        transform: scale(0.96);
      }
      .copy-btn svg {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        stroke-width: 2.5;
        fill: none;
      }

      /* --- 悬浮加号按钮 --- */
      .fab-add {
        position: absolute;
        bottom: 95px;
        right: 20px;
        width: 50px;
        height: 50px;
        background-color: var(--ios-blue);
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        z-index: 50;
        cursor: pointer;
        border: none;
        transition: transform 0.1s, opacity 0.3s;
      }
      .fab-add:active {
        transform: scale(0.92);
      }

      /* --- 底部工具栏 --- */
      .bottom-toolbar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(249, 249, 249, 0.94);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 0.5px solid rgba(0, 0, 0, 0.2);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        padding: 0 10px;
        z-index: 40;
        transition: transform 0.3s ease;

        /* 增加底部内边距 */
        padding-bottom: calc(env(safe-area-inset-bottom) + 5px);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);

        height: auto;
        min-height: 30px;
      }
      .bottom-toolbar.hidden {
        transform: translateY(100%);
        display: grid !important; /* Override hidden display:none for animation */
      }

      .toolbar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 55px;
        background: none;
        border: none;
        cursor: pointer;
        opacity: 0.9;
      }
      .toolbar-item:active {
        opacity: 0.5;
      }
      .toolbar-icon-svg {
        width: 24px;
        height: 24px;
        stroke: var(--ios-blue);
        stroke-width: 1.8;
        fill: none;
        margin-bottom: 4px;
      }
      .toolbar-text {
        font-size: 10px;
        color: var(--ios-blue);
        font-weight: 500;
      }
      .toolbar-item.danger .toolbar-icon-svg {
        stroke: var(--ios-red);
      }
      .toolbar-item.danger .toolbar-text {
        color: var(--ios-red);
      }

      /* === 登录界面 === */
      #auth-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 25vh;
        padding-left: 30px;
        padding-right: 30px;
        height: 100%;
        background-color: var(--ios-bg);
      }

      .app-icon-large {
        width: 80px;
        height: 80px;
        background: var(--ios-surface);
        border-radius: 18px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
      }
      .app-icon-large svg {
        width: 42px;
        height: 42px;
        stroke: var(--ios-blue);
        stroke-width: 2;
        fill: none;
      }

      .auth-title {
        font-size: 26px;
        font-weight: 700;
        margin: 0 0 8px 0;
        color: var(--ios-text-primary);
        letter-spacing: 0.3px;
      }

      .auth-subtitle {
        font-size: 15px;
        color: var(--ios-text-secondary);
        margin: 0 0 40px 0;
        text-align: center;
        line-height: 1.4;
      }

      .ios-list-group {
        width: 100%;
        max-width: 340px;
        background: var(--ios-surface);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 16px;
      }

      .ios-list-input {
        width: 100%;
        border: none;
        padding: 16px;
        font-size: 17px;
        background: transparent;
        color: var(--ios-text-primary);
        text-align: center;
      }
      .ios-list-input:focus {
        outline: none;
        background: rgba(0, 0, 0, 0.01);
      }

      .ios-full-btn {
        width: 100%;
        max-width: 340px;
        background-color: var(--ios-blue);
        color: white;
        font-size: 17px;
        font-weight: 600;
        padding: 14px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
      }
      .ios-full-btn:active {
        opacity: 0.7;
        transform: scale(0.98);
      }
      .ios-full-btn:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .auth-link {
        margin-top: 24px;
        font-size: 14px;
        color: var(--ios-blue);
        background: none;
        border: none;
        cursor: pointer;
        opacity: 0.9;
      }
      .auth-link:active {
        opacity: 0.5;
      }

      /* --- 模态框 --- */
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      }
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-sheet {
        background: var(--ios-bg);
        width: 100%;
        height: 92%;
        border-radius: 12px 12px 0 0;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      }
      .modal-overlay.show .modal-sheet {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top)); /* 稍微给一点余量 */
        background: rgba(242, 242, 247, 0.95);
        border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px 12px 0 0;
        position: relative;
        z-index: 60;
      }
      .modal-btn {
        background: none;
        border: none;
        font-size: 17px;
        color: var(--ios-blue);
        cursor: pointer;
      }
      .modal-btn.save {
        font-weight: 600;
      }
      .modal-btn:disabled {
        opacity: 0.5;
      }

      .modal-body {
        padding: 20px 16px;
        padding-bottom: 250px;
        overflow-y: auto;
        flex: 1;
        position: relative;
        z-index: 1;
      }

      /* 表单组件 */
      .form-group {
        background: var(--ios-surface);
        border-radius: 10px;
        margin-bottom: 24px;
        position: relative;
        overflow: visible;
      }
      .form-group > .form-row:first-child {
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }
      .form-group > .form-row:last-child {
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      }

      .form-row {
        display: flex;
        align-items: center;
        min-height: 44px;
        padding-left: 16px;
        background: var(--ios-surface);
      }
      .form-content {
        flex: 1;
        display: flex;
        align-items: center;
        border-bottom: 0.5px solid var(--ios-separator);
        padding-right: 16px;
        min-height: 44px;
        position: relative;
      }
      .form-row:last-child .form-content {
        border-bottom: none;
      }

      .form-label {
        width: 80px;
        font-size: 17px;
      }
      .form-input {
        flex: 1;
        border: none;
        font-size: 17px;
        height: 40px;
        text-align: right;
        background: transparent;
        color: #000;
        border-radius: 0;
        min-width: 0;
      }
      .form-input:focus {
        outline: none;
      }

      .form-section-label {
        padding-left: 5px;
        font-size: 13px;
        color: var(--ios-text-secondary);
        margin-top: -13px;
        margin-bottom: 10px;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .pwd-toggle-btn {
        background: none;
        border: none;
        padding: 0 0 0 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .pwd-toggle-icon {
        width: 20px;
        height: 20px;
        stroke: var(--ios-blue);
        stroke-width: 2;
        fill: none;
      }

      .add-field-btn {
        width: 100%;
        background: var(--ios-surface);
        color: var(--ios-blue);
        border: none;
        padding: 10px;
        border-radius: 10px;
        font-size: 17px;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        margin-top: 5px;
        margin-bottom: 20px;
      }
      .add-field-btn:active {
        background-color: #e5e5ea;
      }

      .home-indicator {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 130px;
        height: 5px;
        background: #000;
        border-radius: 100px;
        z-index: 999;
        pointer-events: none;
      }

      .toast {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) scale(0.9);
        background: rgba(40, 40, 40, 0.9);
        backdrop-filter: blur(10px);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 15px;
        font-weight: 500;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
        z-index: 300;
        width: max-content;
        text-align: center;
        max-width: 80%;
      }
      .toast.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) scale(1);
      }

      /* --- 通用模态弹窗 --- */
      .alert-modal {
        background: rgba(245, 245, 245, 0.95);
        backdrop-filter: blur(20px);
        width: 280px;
        border-radius: 14px;
        text-align: center;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 0;
        transition: all 0.2s;
        z-index: 400;
      }
      .modal-overlay.show .alert-modal {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      .alert-actions {
        display: flex;
        border-top: 0.5px solid rgba(60, 60, 67, 0.2);
      }
      .alert-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: transparent;
        font-size: 17px;
        color: var(--ios-blue);
        border-right: 0.5px solid rgba(60, 60, 67, 0.2);
        cursor: pointer;
      }
      .alert-btn:last-child {
        border-right: none;
        font-weight: 600;
      }
      .alert-btn.full-width {
        border-right: none;
        flex: 1 1 100%;
      }

      .transparent-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 150;
        display: none;
        cursor: default;
      }

      #dropdown-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 190;
        display: none;
      }
      /*
      @media (max-width: 500px) {
        body {
          background-color: var(--ios-bg);
          align-items: flex-start;
        }
        #device-frame {
          width: 100%;
          height: 100vh;
          border-radius: 0;
          box-shadow: none;
          border: none;
        }
        .toast {
          bottom: 120px;
        }
      }*/

      @media (max-width: 500px) {
        /* 让 Body 占满全屏，无滚动条 */
        body {
          background-color: var(--ios-bg);
          align-items: flex-start; /* 从顶部开始对齐 */
          overflow: hidden; /* 禁止 body 滚动，只允许 app-container 滚动 */
          position: fixed; /* 锁死页面防止橡皮筋效果拖动整个网页 */
          width: 100%;
          height: 100%;
        }

        /* 彻底移除设备外壳样式 */
        #device-frame {
          width: 100%;
          height: 100%; /* 占满视口 */
          border-radius: 0;
          box-shadow: none;
          border: none;
          background-color: var(--ios-bg);
        }

        /* 调整 Toast 位置，避免被键盘或手指遮挡 */
        .toast {
          bottom: 50%; /* 移到屏幕中间可能更醒目，或者底部偏上 */
        }

        /* 隐藏那个模拟的底部横条 (Home Indicator)，因为真机自己有 */
        .home-indicator {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="device-frame">
      <div class="app-container">
        <div id="auth-screen" class="anim-view">
          <div class="app-icon-large">
            <svg
              viewBox="0 0 24 24"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>

          <div class="auth-title">MyKeys</div>
          <div class="auth-subtitle">本地加密存储</div>

          <form
            onsubmit="event.preventDefault(); app.handleAuth();"
            style="
              width: 100%;
              display: flex;
              flex-direction: column;
              align-items: center;
            "
          >
            <div class="ios-list-group">
              <input
                type="password"
                id="master-password"
                class="ios-list-input"
                placeholder="输入主密码"
                autofocus
              />
            </div>

            <button type="submit" class="ios-full-btn">解锁</button>
          </form>

          <input
            type="file"
            id="restore-file"
            class="hidden"
            onchange="app.restoreFromFile(this)"
          />
          <button
            class="auth-link"
            onclick="document.getElementById('restore-file').click()"
          >
            从备份恢复
          </button>
        </div>

        <div id="app-screen" class="anim-view hidden view-hidden-after">
          <div class="nav-bar">
            <div class="nav-header">
              <h1 class="nav-title">MyKeys</h1>
            </div>
            <div class="search-container">
              <input
                type="text"
                id="search-input"
                class="search-input"
                placeholder="搜索"
                oninput="app.renderList()"
              />
            </div>

            <div class="custom-select-wrapper" id="custom-filter">
              <div
                class="custom-select-trigger"
                onclick="app.toggleFilterMenu()"
              >
                <span class="trigger-text" id="current-filter-label"
                  >显示全部</span
                >
                <svg
                  class="trigger-icon"
                  viewBox="0 0 24 24"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
              <div
                class="custom-dropdown-menu"
                id="filter-options-container"
              ></div>
            </div>
            <div id="dropdown-backdrop" onclick="app.closeFilterMenu()"></div>
          </div>

          <div class="content-area">
            <div id="account-list"></div>
          </div>
        </div>
      </div>

      <button
        id="add-entry-btn"
        class="fab-add hidden"
        onclick="app.openModal()"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>

      <div id="toolbar-container" class="bottom-toolbar hidden">
        <button class="toolbar-item" onclick="app.lock()">
          <svg
            class="toolbar-icon-svg"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          <span class="toolbar-text">锁定</span>
        </button>

        <button class="toolbar-item" onclick="app.preImportCheck()">
          <svg
            class="toolbar-icon-svg"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          <span class="toolbar-text">导入</span>
        </button>

        <button class="toolbar-item" onclick="app.preExportCheck()">
          <svg
            class="toolbar-icon-svg"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <span class="toolbar-text">导出</span>
        </button>

        <button class="toolbar-item danger" onclick="app.resetData()">
          <svg
            class="toolbar-icon-svg"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="3 6 5 6 21 6"></polyline>
            <path
              d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
            ></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          <span class="toolbar-text">注销</span>
        </button>

        <input
          type="file"
          id="import-file"
          class="hidden"
          onchange="app.importData(this)"
        />
      </div>

      <div class="home-indicator"></div>

      <div id="modal-overlay" class="modal-overlay">
        <div class="modal-sheet">
          <div class="modal-header">
            <button class="modal-btn" onclick="app.closeModal()">取消</button>
            <span class="modal-title" id="modal-title">详情</span>
            <button
              class="modal-btn save"
              onclick="document.getElementById('btn-save').click()"
            >
              保存
            </button>
          </div>
          <div class="modal-body">
            <form
              id="entry-form"
              onsubmit="event.preventDefault(); app.saveEntry();"
            >
              <input type="hidden" id="entry-id" />
              <button type="submit" id="btn-save" class="hidden"></button>

              <div class="form-section-label">基本信息</div>
              <div class="form-group">
                <div class="form-row">
                  <div class="form-content">
                    <span class="form-label">名称</span
                    ><input
                      type="text"
                      id="f-appName"
                      class="form-input"
                      placeholder="必填"
                      required
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-content">
                    <span class="form-label">分类</span>
                    <div
                      style="
                        flex: 1;
                        display: flex;
                        align-items: center;
                        position: relative;
                      "
                    >
                      <input type="hidden" id="f-category" value="默认" />

                      <div
                        class="custom-select-wrapper form-select"
                        id="wrap-f-category"
                      >
                        <div
                          class="custom-select-trigger"
                          onclick="app.toggleFormSelect('f-category')"
                        >
                          <span class="trigger-text" id="display-f-category"
                            >默认</span
                          >
                          <svg
                            class="trigger-icon"
                            viewBox="0 0 24 24"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="6 9 12 15 18 9"></polyline>
                          </svg>
                        </div>
                        <div
                          class="custom-dropdown-menu"
                          id="list-f-category"
                        ></div>
                      </div>

                      <input
                        type="text"
                        id="f-new-category"
                        class="form-input hidden"
                        placeholder="请输入分类"
                        onblur="app.revertCategoryIfEmpty(this)"
                        style="width: 100%"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section-label">账号详情</div>
              <div class="form-group">
                <div class="form-row">
                  <div class="form-content">
                    <span class="form-label">用户名</span
                    ><input
                      type="text"
                      id="f-username"
                      class="form-input"
                      placeholder="未设置"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-content">
                    <span class="form-label">密码</span>
                    <input
                      type="password"
                      id="f-password"
                      class="form-input"
                      placeholder="未设置"
                      autocomplete="new-password"
                    />
                    <button
                      type="button"
                      class="pwd-toggle-btn"
                      id="btn-pwd-toggle"
                      onclick="app.toggleFieldVisibility('f-password')"
                    >
                      <svg
                        class="pwd-toggle-icon"
                        viewBox="0 0 24 24"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                        ></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-content">
                    <span class="form-label">手机</span
                    ><input
                      type="tel"
                      id="f-phone"
                      class="form-input"
                      placeholder="未设置"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-content">
                    <span class="form-label">邮箱</span
                    ><input
                      type="email"
                      id="f-email"
                      class="form-input"
                      placeholder="未设置"
                    />
                  </div>
                </div>
              </div>

              <div class="form-section-label">其他</div>
              <div class="form-group">
                <div class="form-row">
                  <div class="form-content">
                    <span class="form-label">昵称</span
                    ><input type="text" id="f-nickname" class="form-input" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-content">
                    <span
                      class="form-label"
                      style="width: auto; margin-right: 10px"
                      >关联账号</span
                    >
                    <div
                      style="
                        flex: 1;
                        display: flex;
                        justify-content: flex-end;
                        align-items: center;
                        position: relative;
                      "
                    >
                      <input
                        type="checkbox"
                        id="f-isLinked"
                        onchange="app.toggleLinkedSelect()"
                        style="margin-right: 10px"
                      />

                      <input type="hidden" id="f-linkedId" />
                      <div
                        class="custom-select-wrapper form-select hidden"
                        id="wrap-f-linkedId"
                      >
                        <div
                          class="custom-select-trigger"
                          onclick="app.toggleFormSelect('f-linkedId')"
                        >
                          <span class="trigger-text" id="display-f-linkedId"
                            >请选择</span
                          >
                          <svg
                            class="trigger-icon"
                            viewBox="0 0 24 24"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="6 9 12 15 18 9"></polyline>
                          </svg>
                        </div>
                        <div
                          class="custom-dropdown-menu"
                          id="list-f-linkedId"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section-label">自定义字段</div>
              <div id="custom-fields-container"></div>

              <button
                type="button"
                class="add-field-btn"
                onclick="app.addCustomFieldUI()"
              >
                添加字段
              </button>

              <div style="margin-top: 30px; text-align: center">
                <button
                  type="button"
                  id="btn-delete"
                  class="hidden"
                  style="
                    color: var(--ios-red);
                    background: white;
                    width: 100%;
                    padding: 14px;
                    border-radius: 10px;
                    border: none;
                    font-size: 17px;
                    margin-bottom: 10px;
                  "
                  onclick="app.deleteEntry()"
                >
                  删除此账号
                </button>
              </div>
            </form>

            <div
              id="form-dropdown-backdrop"
              class="transparent-backdrop"
              onclick="app.closeFormDropdowns()"
            ></div>
          </div>
        </div>
      </div>

      <div id="universal-modal" class="modal-overlay">
        <div class="alert-modal">
          <div style="padding: 20px 16px">
            <h3 id="u-modal-title" style="margin: 0 0 5px 0; font-size: 17px">
              提示
            </h3>
            <p
              id="u-modal-msg"
              style="
                margin: 0 0 15px 0;
                font-size: 13px;
                line-height: 1.4;
                white-space: pre-wrap;
              "
            >
              内容
            </p>
            <input
              type="password"
              id="u-modal-input"
              class="hidden"
              style="
                width: 100%;
                padding: 5px;
                border: 0.5px solid #ccc;
                height: 30px;
                border-radius: 4px;
              "
            />
          </div>
          <div class="alert-actions">
            <button
              id="u-modal-cancel"
              class="alert-btn"
              onclick="app.closeUniversalModal(false)"
            >
              取消
            </button>
            <button
              id="u-modal-confirm"
              class="alert-btn"
              onclick="app.closeUniversalModal(true)"
            >
              确定
            </button>
          </div>
        </div>
      </div>

      <div id="toast" class="toast">消息提示</div>
    </div>
    <script>
      const Crypto = {
        ITERATIONS: 600000,

        generateSalt: () => window.crypto.getRandomValues(new Uint8Array(16)),
        generateIV: () => window.crypto.getRandomValues(new Uint8Array(12)),

        getUUID: () => {
          if (typeof crypto.randomUUID === "function") {
            return crypto.randomUUID();
          }
          return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              var r = (Math.random() * 16) | 0,
                v = c == "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
        },

        deriveKey: async (password, salt) => {
          const enc = new TextEncoder();
          const keyMaterial = await window.crypto.subtle.importKey(
            "raw",
            enc.encode(password),
            { name: "PBKDF2" },
            false,
            ["deriveKey"]
          );
          return window.crypto.subtle.deriveKey(
            {
              name: "PBKDF2",
              salt: salt,
              iterations: Crypto.ITERATIONS,
              hash: "SHA-256",
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
          );
        },
        encrypt: async (data, password) => {
          const salt = Crypto.generateSalt();
          const iv = Crypto.generateIV();
          const key = await Crypto.deriveKey(password, salt);
          const encrypted = await window.crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            key,
            new TextEncoder().encode(JSON.stringify(data))
          );
          return JSON.stringify({
            salt: btoa(String.fromCharCode(...salt)),
            iv: btoa(String.fromCharCode(...iv)),
            data: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
          });
        },
        decrypt: async (packedData, password) => {
          try {
            const obj = JSON.parse(packedData);
            const salt = Uint8Array.from(atob(obj.salt), (c) =>
              c.charCodeAt(0)
            );
            const iv = Uint8Array.from(atob(obj.iv), (c) => c.charCodeAt(0));
            const data = Uint8Array.from(atob(obj.data), (c) =>
              c.charCodeAt(0)
            );
            const key = await Crypto.deriveKey(password, salt);
            const decrypted = await window.crypto.subtle.decrypt(
              { name: "AES-GCM", iv: iv },
              key,
              data
            );
            return JSON.parse(new TextDecoder().decode(decrypted));
          } catch (e) {
            console.warn("Decrypt failed:", e);
            return null;
          }
        },
      };

      const app = {
        data: [],
        masterKey: null,
        autoLockTimer: null,
        defaultCategories: [
          "默认",
          "社交",
          "购物",
          "娱乐",
          "教育",
          "金融",
          "办公",
        ],
        currentFilter: "All",

        // 通用模态框 Promise 解决器
        modalResolve: null,
        openFormSelectId: null,

        init: () => {
          window.addEventListener("storage", async (e) => {
            if (e.key === "mykeys_data" && app.masterKey) {
              if (
                await app.showConfirm(
                  "数据已在其他页面更新，是否刷新以加载最新数据？",
                  "数据同步"
                )
              ) {
                location.reload();
              }
            }
          });
        },

        showToast: (msg) => {
          const t = document.getElementById("toast");
          t.innerText = msg;
          t.classList.add("show");
          if (t.hideTimer) clearTimeout(t.hideTimer);
          t.hideTimer = setTimeout(() => t.classList.remove("show"), 2000);
        },

        resetAutoLock: () => {
          if (app.autoLockTimer) clearTimeout(app.autoLockTimer);
          app.autoLockTimer = setTimeout(() => {
            if (
              !document
                .getElementById("app-screen")
                .classList.contains("hidden")
            )
              app.lock();
          }, 5 * 60 * 1000);
        },

        initAutoLockEvents: () => {
          window.addEventListener("mousemove", app.resetAutoLock);
          window.addEventListener("keydown", app.resetAutoLock);
          window.addEventListener("click", app.resetAutoLock);
          window.addEventListener("touchstart", app.resetAutoLock);
          app.resetAutoLock();
        },

        // --- 通用模态框逻辑 ---

        _toggleModal: (options) => {
          return new Promise((resolve) => {
            app.modalResolve = resolve;

            document.getElementById("u-modal-title").innerText =
              options.title || "提示";
            document.getElementById("u-modal-msg").innerText =
              options.message || "";

            const inputEl = document.getElementById("u-modal-input");
            if (options.type === "prompt") {
              inputEl.classList.remove("hidden");
              inputEl.value = "";
              inputEl.type = options.inputType || "text";
              inputEl.placeholder = options.placeholder || "";
              setTimeout(() => inputEl.focus(), 100);
            } else {
              inputEl.classList.add("hidden");
            }

            const cancelBtn = document.getElementById("u-modal-cancel");
            const confirmBtn = document.getElementById("u-modal-confirm");

            if (options.type === "alert") {
              cancelBtn.classList.add("hidden");
              confirmBtn.classList.add("full-width");
            } else {
              cancelBtn.classList.remove("hidden");
              confirmBtn.classList.remove("full-width");
              if (options.confirmText)
                confirmBtn.innerText = options.confirmText;
              else confirmBtn.innerText = "确定";
            }

            document.getElementById("universal-modal").classList.add("show");
          });
        },

        closeUniversalModal: (result) => {
          document.getElementById("universal-modal").classList.remove("show");

          setTimeout(() => {
            if (app.modalResolve) {
              const inputVal = document.getElementById("u-modal-input").value;
              const isPrompt = !document
                .getElementById("u-modal-input")
                .classList.contains("hidden");

              if (isPrompt) {
                app.modalResolve(result ? inputVal : null);
              } else {
                app.modalResolve(result);
              }
              app.modalResolve = null;
            }
          }, 50);
        },

        showAlert: async (message, title = "提示") => {
          return app._toggleModal({ type: "alert", message, title });
        },

        showConfirm: async (message, title = "提示", confirmText = "确定") => {
          return app._toggleModal({
            type: "confirm",
            message,
            title,
            confirmText,
          });
        },

        askForPassword: async (message) => {
          return app._toggleModal({
            type: "prompt",
            message,
            title: "验证保护",
            inputType: "password",
          });
        },

        // --- 业务逻辑 ---

        handleAuth: async () => {
          const pwd = document.getElementById("master-password").value;
          if (!pwd) return app.showToast("请输入密码");

          if (pwd === "admin888") {
            if (
              await app.showConfirm(
                "管理员：是否强制清空并重置所有数据？\n(无法解密用户数据，只能清空)",
                "危险操作"
              )
            ) {
              localStorage.removeItem("mykeys_data");
              await app.showAlert("数据已重置");
              location.reload();
              return;
            } else {
              app.data = [];
              app.masterKey = "temp_admin_key";
              app.unlockUI();
              app.showToast("管理员预览模式");
              return;
            }
          }

          const saved = localStorage.getItem("mykeys_data");
          const btn = document.querySelector("#auth-screen .ios-full-btn");
          const originalText = btn.innerText;
          btn.innerText = "处理中...";
          btn.disabled = true;

          setTimeout(async () => {
            try {
              if (saved) {
                const decrypted = await Crypto.decrypt(saved, pwd);
                if (decrypted) {
                  app.data = decrypted;
                  app.masterKey = pwd;
                  app.unlockUI();
                } else {
                  app.showToast("密码错误");
                }
              } else {
                if (
                  await app.showConfirm(
                    "这是首次使用，确认将此密码设为主密码吗？",
                    "设置密码"
                  )
                ) {
                  app.data = [];
                  app.masterKey = pwd;
                  await app.saveData();
                  app.unlockUI();
                }
              }
            } finally {
              btn.innerText = originalText;
              btn.disabled = false;
            }
          }, 50);
        },

        lock: () => {
          const auth = document.getElementById("auth-screen");
          const appSc = document.getElementById("app-screen");
          const toolbar = document.getElementById("toolbar-container");
          const fab = document.getElementById("add-entry-btn");

          // 动画：反向操作
          appSc.classList.add("view-hidden-after");
          // Auth Screen 准备入场
          auth.classList.remove("hidden");
          auth.classList.add("view-hidden-before"); // 初始缩小状态
          toolbar.classList.add("hidden");
          fab.classList.add("hidden");

          // 强制重绘
          void auth.offsetWidth;

          // 执行动画
          setTimeout(() => {
            appSc.style.opacity = "0";
            auth.classList.remove("view-hidden-before"); // 恢复正常状态
          }, 10);

          app.masterKey = null;
          app.data = [];

          // 延迟刷新页面以确保内存安全，同时等待动画完成大部分
          setTimeout(() => {
            location.reload();
          }, 400);
        },

        unlockUI: () => {
          const auth = document.getElementById("auth-screen");
          const appSc = document.getElementById("app-screen");
          const toolbar = document.getElementById("toolbar-container");
          const fab = document.getElementById("add-entry-btn");

          // 1. Auth screen 退出动画
          auth.classList.add("view-hidden-before");

          // 2. 准备 App Screen
          appSc.classList.remove("hidden");
          // 确保它处于"准备入场"状态 (放大且模糊)
          // void appSc.offsetWidth; // 触发重绘

          setTimeout(() => {
            // 3. Auth 隐藏 (等待动画结束后再完全隐藏，这里用CSS transition时间)
            // 4. App Screen 进入
            appSc.classList.remove("view-hidden-after");

            // 显示工具栏
            toolbar.classList.remove("hidden");
            fab.classList.remove("hidden");
          }, 50);

          setTimeout(() => {
            auth.classList.add("hidden");
            auth.classList.remove("view-hidden-before"); // 重置状态供下次使用
          }, 400);

          app.initAutoLockEvents();
          app.updateFilterOptions();
          app.renderList();
        },

        resetData: async () => {
          if (
            await app.showConfirm(
              "危险：确定销毁所有数据吗？无法撤销！",
              "警告"
            )
          ) {
            localStorage.removeItem("mykeys_data");
            location.reload();
          }
        },

        saveData: async () => {
          if (!app.masterKey) return;
          try {
            const encrypted = await Crypto.encrypt(app.data, app.masterKey);
            localStorage.setItem("mykeys_data", encrypted);
            app.updateFilterOptions();
          } catch (e) {
            app.showAlert("保存失败，存储空间可能已满", "错误");
          }
        },

        // --- 顶部筛选 ---
        toggleFilterMenu: () => {
          const wrap = document.getElementById("custom-filter");
          const backdrop = document.getElementById("dropdown-backdrop");
          if (wrap.classList.contains("open")) {
            app.closeFilterMenu();
          } else {
            wrap.classList.add("open");
            backdrop.style.display = "block";
          }
        },
        closeFilterMenu: () => {
          document.getElementById("custom-filter").classList.remove("open");
          document.getElementById("dropdown-backdrop").style.display = "none";
        },
        selectFilter: (val) => {
          app.currentFilter = val;
          document.getElementById("current-filter-label").innerText =
            val === "All" ? "显示全部" : val;
          app.closeFilterMenu();
          app.renderList();
          app.updateFilterOptions();
        },

        // --- 表单内下拉 ---
        toggleFormSelect: (id) => {
          const wrap = document.getElementById(`wrap-${id}`);
          const backdrop = document.getElementById("form-dropdown-backdrop");

          if (app.openFormSelectId === id) {
            app.closeFormDropdowns();
            return;
          }
          if (app.openFormSelectId) {
            app.closeFormDropdowns();
          }

          wrap.classList.add("open");
          backdrop.style.display = "block";
          app.openFormSelectId = id;
        },

        closeFormDropdowns: () => {
          if (app.openFormSelectId) {
            document
              .getElementById(`wrap-${app.openFormSelectId}`)
              .classList.remove("open");
            document.getElementById("form-dropdown-backdrop").style.display =
              "none";
            app.openFormSelectId = null;
          }
        },

        selectFormOption: (id, val, text, isCustom = false) => {
          if (isCustom) {
            document.getElementById(`wrap-${id}`).classList.add("hidden");
            const input = document.getElementById("f-new-category");
            input.classList.remove("hidden");
            input.value = "";
            setTimeout(() => input.focus(), 50);
          } else {
            document.getElementById(id).value = val;
            const displayEl = document.getElementById(`display-${id}`);
            displayEl.innerText = text;

            const wrap = document.getElementById(`wrap-${id}`);
            if (val && val !== "") {
              wrap.classList.add("has-value");
            } else {
              wrap.classList.remove("has-value");
            }
          }
          app.closeFormDropdowns();
        },

        copyText: (text) => {
          if (!text) return app.showToast("内容为空");
          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard
              .writeText(text)
              .then(() => app.showToast("已复制"))
              .catch(() => app.copyTextFallback(text));
          } else {
            app.copyTextFallback(text);
          }
        },

        copyPassword: (id, e) => {
          if (e) e.stopPropagation();
          const item = app.data.find((i) => i.id === id);
          if (item && item.password) {
            app.copyText(item.password);
          } else {
            app.showToast("无密码");
          }
        },

        copyTextFallback: (text) => {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.opacity = "0";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand("copy");
            app.showToast("已复制");
          } catch (err) {
            app.showToast("无法复制");
          }
          document.body.removeChild(textArea);
        },

        // --- 导入导出 新增逻辑 ---

        preExportCheck: async () => {
          const msg =
            "即将导出加密的 JSON 文件。\n\n注意事项：\n1. 文件使用当前的【主密码】加密。\n2. 请妥善保管此文件，切勿发给他人。\n3. 恢复时需要验证此密码。\n\n是否继续？";
          if (await app.showConfirm(msg, "导出备份", "继续导出")) {
            app.exportBackup();
          }
        },

        exportBackup: async () => {
          const encryptedData = localStorage.getItem("mykeys_data");
          if (!encryptedData) return app.showToast("无数据");
          const blob = new Blob([encryptedData], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `mykeys_${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          app.showToast("已导出");
        },

        preImportCheck: async () => {
          const msg =
            "请选择之前导出的 JSON 备份文件。系统将自动合并数据：\n\n1. 若 ID 相同，更新为最新数据。\n2. 若文件密码与当前不同，需输入原密码验证。\n3. 请确保文件来源可信。\n\n是否继续？";
          if (await app.showConfirm(msg, "导入数据", "选择文件")) {
            document.getElementById("import-file").click();
          }
        },

        importData: (input) => {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const content = e.target.result;
              let importedData = await Crypto.decrypt(content, app.masterKey);
              if (!importedData) {
                const filePwd = await app.askForPassword(
                  "文件密码不同，请输入该文件的密码："
                );
                if (!filePwd) return (input.value = "");
                importedData = await Crypto.decrypt(content, filePwd);
              }

              if (importedData && Array.isArray(importedData)) {
                let addCount = 0;
                let updateCount = 0;

                importedData.forEach((newItem) => {
                  const idx = app.data.findIndex(
                    (old) => old.id === newItem.id
                  );
                  if (idx === -1) {
                    app.data.push(newItem);
                    addCount++;
                  } else {
                    const oldTime = app.data[idx].updatedAt
                      ? new Date(app.data[idx].updatedAt).getTime()
                      : 0;
                    const newTime = newItem.updatedAt
                      ? new Date(newItem.updatedAt).getTime()
                      : 0;
                    if (newTime > oldTime) {
                      app.data[idx] = newItem;
                      updateCount++;
                    }
                  }
                });

                await app.saveData();
                app.showToast(`新增 ${addCount} 条，更新 ${updateCount} 条`);
                app.renderList();
              } else {
                app.showToast("密码错误或格式无效");
              }
            } catch (err) {
              console.error(err);
              app.showToast("文件解析错误");
            }
            input.value = "";
          };
          reader.readAsText(file);
        },

        restoreFromFile: (input) => {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const content = e.target.result;
              JSON.parse(content);
              const pwd = await app.askForPassword("请输入备份文件的主密码：");
              if (!pwd) return (input.value = "");

              const decrypted = await Crypto.decrypt(content, pwd);
              if (decrypted) {
                if (
                  await app.showConfirm(
                    "警告：恢复备份将【清空并覆盖】当前所有数据！\n是否继续？",
                    "危险操作"
                  )
                ) {
                  localStorage.setItem("mykeys_data", content);
                  await app.showAlert("恢复成功");
                  location.reload();
                }
              } else {
                app.showToast("密码错误");
              }
            } catch (err) {
              app.showToast("无效文件");
            }
            input.value = "";
          };
          reader.readAsText(file);
        },

        renderList: () => {
          const list = document.getElementById("account-list");
          list.innerHTML = "";
          const search = document
            .getElementById("search-input")
            .value.toLowerCase();
          const filterCat = app.currentFilter;
          const filtered = app.data.filter((item) => {
            const matchSearch = (
              item.appName +
              item.username +
              (item.nickname || "")
            )
              .toLowerCase()
              .includes(search);
            const matchCat = filterCat === "All" || item.category === filterCat;
            return matchSearch && matchCat;
          });

          if (filtered.length === 0) {
            list.innerHTML =
              '<p style="text-align:center; color:var(--ios-text-secondary); margin-top:40px;">暂无数据</p>';
            return;
          }

          filtered.forEach((item) => {
            const div = document.createElement("div");
            div.className = "list-group";
            let html = `
                <div class="list-row" onclick="app.editEntry('${item.id}')">
                    <div class="list-content">
                        <div class="row-main">
                            <span class="row-title">${app.escapeHtml(
                              item.appName
                            )}</span>
                            <span class="row-subtitle">${app.escapeHtml(
                              item.username || "无用户名"
                            )}</span>
                        </div>
                        <span class="tag-pill">${app.escapeHtml(
                          item.category
                        )}</span>
                    </div>
                </div>`;
            if (item.password) {
              html += `<div class="list-row">
                <div class="list-content">
                    <span style="font-family:monospace; font-size:15px; letter-spacing:2px;">••••••</span>
                    <button class="copy-btn" onclick="app.copyPassword('${item.id}', event)">
                        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                        复制
                    </button>
                </div>
              </div>`;
            }
            div.innerHTML = html;
            list.appendChild(div);
          });
        },

        openModal: (isEdit = false) => {
          document.getElementById("modal-overlay").classList.add("show");

          const catListEl = document.getElementById("list-f-category");
          catListEl.innerHTML = "";
          const existingCats = [...new Set(app.data.map((i) => i.category))];
          const allCats = [
            ...new Set([...app.defaultCategories, ...existingCats]),
          ];

          const currentCat = isEdit
            ? document.getElementById("f-category").value
            : "默认";
          if (!isEdit) {
            app.selectFormOption("f-category", "默认", "默认");
          }

          allCats.forEach((c) => {
            const div = document.createElement("div");
            div.className = `custom-option ${
              currentCat === c ? "selected" : ""
            }`;
            div.onclick = (e) => {
              e.stopPropagation();
              app.selectFormOption("f-category", c, c);
            };
            div.innerHTML = `<span>${app.escapeHtml(
              c
            )}</span><span class="check-icon">✓</span>`;
            catListEl.appendChild(div);
          });

          const customDiv = document.createElement("div");
          customDiv.className = "custom-option";
          customDiv.style.color = "var(--ios-blue)";
          customDiv.onclick = (e) => {
            e.stopPropagation();
            app.selectFormOption("f-category", null, null, true);
          };
          customDiv.innerHTML = `<span>自定义...</span>`;
          catListEl.appendChild(customDiv);

          app.populateLinkedOptions(
            isEdit ? document.getElementById("entry-id").value : null
          );
        },

        populateLinkedOptions: (excludeId = null) => {
          const listEl = document.getElementById("list-f-linkedId");
          listEl.innerHTML = "";

          const noneDiv = document.createElement("div");
          noneDiv.className = "custom-option";
          noneDiv.onclick = (e) => {
            e.stopPropagation();
            app.selectFormOption("f-linkedId", "", "无");
          };
          noneDiv.innerHTML = `<span>无</span>`;
          listEl.appendChild(noneDiv);

          app.data.forEach((d) => {
            if (d.id !== excludeId) {
              const div = document.createElement("div");
              div.className = "custom-option";
              div.onclick = (e) => {
                e.stopPropagation();
                app.selectFormOption("f-linkedId", d.id, d.appName);
              };
              div.innerHTML = `<span>${app.escapeHtml(d.appName)}</span>`;
              listEl.appendChild(div);
            }
          });
        },

        closeModal: () => {
          document.getElementById("modal-overlay").classList.remove("show");
          app.closeFormDropdowns();
          setTimeout(() => {
            document.getElementById("entry-form").reset();
            document.getElementById("custom-fields-container").innerHTML = "";
            app.resetCategory();

            document.getElementById("f-linkedId").value = "";
            document.getElementById("display-f-linkedId").innerText = "请选择";
            document.getElementById("wrap-f-linkedId").classList.add("hidden");
            document
              .getElementById("wrap-f-linkedId")
              .classList.remove("has-value");
            document.getElementById("f-linkedId").disabled = true;

            document.getElementById("f-password").type = "password";
            app.updatePwdIcon(false);

            document.getElementById("btn-delete").classList.add("hidden");
          }, 300);
        },

        revertCategoryIfEmpty: (input) => {
          if (!input.value.trim()) {
            input.classList.add("hidden");
            const wrap = document.getElementById("wrap-f-category");
            wrap.classList.remove("hidden");
            app.selectFormOption("f-category", "默认", "默认");
          }
        },
        resetCategory: () => {
          document.getElementById("f-new-category").classList.add("hidden");
          document.getElementById("wrap-f-category").classList.remove("hidden");
        },

        toggleLinkedSelect: () => {
          const chk = document.getElementById("f-isLinked");
          const wrap = document.getElementById("wrap-f-linkedId");
          if (chk.checked) {
            wrap.classList.remove("hidden");
            document.getElementById("f-linkedId").disabled = false;
          } else {
            wrap.classList.add("hidden");
            document.getElementById("f-linkedId").disabled = true;
            document.getElementById("f-linkedId").value = "";
            document.getElementById("display-f-linkedId").innerText = "请选择";
            wrap.classList.remove("has-value");
          }
        },
        addCustomFieldUI: (k = "", v = "") => {
          const div = document.createElement("div");
          div.className = "form-group";
          div.style.marginBottom = "10px";
          div.innerHTML = `<div class="form-row"><div class="form-content"><input type="text" placeholder="字段名" value="${k}" class="c-key form-input" style="text-align:left;"></div></div><div class="form-row"><div class="form-content"><input type="text" placeholder="内容" value="${v}" class="c-val form-input" style="text-align:left;"></div></div><button type="button" style="width:100%; color:var(--ios-red); border:none; background:none; padding:14px; font-size: 17px; font-weight: 500;" onclick="this.parentElement.remove()">移除</button>`;
          document.getElementById("custom-fields-container").appendChild(div);
        },

        saveEntry: async () => {
          const btn = document.querySelector(".modal-btn.save");
          const originalText = btn.innerText;
          btn.disabled = true;
          btn.innerText = "保存中...";

          try {
            const id = document.getElementById("entry-id").value;
            const appName = document.getElementById("f-appName").value;

            let category;
            const catInput = document.getElementById("f-new-category");

            if (!catInput.classList.contains("hidden")) {
              category = catInput.value;
            } else {
              category = document.getElementById("f-category").value;
            }

            if (!category || !category.trim()) {
              if (
                !catInput.classList.contains("hidden") &&
                !catInput.value.trim()
              ) {
                catInput.focus();
                app.showToast("请填写分类名称");
                throw new Error("Validation Error");
              }
              category = "默认";
            }

            if (!appName) {
              app.showToast("应用名称必填");
              throw new Error("Validation Error");
            }

            const customFields = [];
            document
              .querySelectorAll(".form-group .c-key")
              .forEach((keyInput) => {
                const valInput = keyInput
                  .closest(".form-group")
                  .querySelector(".c-val");
                if (keyInput.value)
                  customFields.push({
                    key: keyInput.value,
                    val: valInput.value,
                  });
              });

            const entry = {
              id: id || Crypto.getUUID(),
              appName,
              category,
              username: document.getElementById("f-username").value,
              password: document.getElementById("f-password").value,
              nickname: document.getElementById("f-nickname").value,
              phone: document.getElementById("f-phone").value,
              email: document.getElementById("f-email").value,
              linkedId: document.getElementById("f-isLinked").checked
                ? document.getElementById("f-linkedId").value
                : null,
              customFields,
              updatedAt: new Date().toISOString(),
            };

            if (id) app.data[app.data.findIndex((x) => x.id === id)] = entry;
            else app.data.push(entry);

            await app.saveData();

            app.closeModal();
            app.renderList();
            app.showToast("已保存");
          } catch (err) {
            if (err.message !== "Validation Error") {
              console.error("Save Error:", err);
              await app.showAlert(
                "保存失败：可能是加密出错或存储空间已满。",
                "错误"
              );
            }
          } finally {
            btn.disabled = false;
            btn.innerText = originalText;
          }
        },

        editEntry: (id) => {
          app.openModal(true);
          const item = app.data.find((x) => x.id === id);
          if (!item) return;
          document.getElementById("modal-title").innerText = "编辑账号";
          document.getElementById("entry-id").value = item.id;
          document.getElementById("f-appName").value = item.appName;

          app.selectFormOption("f-category", item.category, item.category);

          document.getElementById("f-username").value = item.username || "";
          document.getElementById("f-password").value = item.password || "";
          document.getElementById("f-nickname").value = item.nickname || "";
          document.getElementById("f-phone").value = item.phone || "";
          document.getElementById("f-email").value = item.email || "";

          if (item.linkedId) {
            document.getElementById("f-isLinked").checked = true;
            app.toggleLinkedSelect();
            const linkedItem = app.data.find((d) => d.id === item.linkedId);
            const linkedName = linkedItem ? linkedItem.appName : "未知(已删除)";
            app.selectFormOption("f-linkedId", item.linkedId, linkedName);
          }
          if (item.customFields)
            item.customFields.forEach((cf) =>
              app.addCustomFieldUI(cf.key, cf.val)
            );
          document.getElementById("btn-delete").classList.remove("hidden");
        },

        deleteEntry: async () => {
          if (await app.showConfirm("确定要删除此账号吗？")) {
            const deleteId = document.getElementById("entry-id").value;
            app.data = app.data.filter((x) => x.id !== deleteId);

            app.data.forEach((item) => {
              if (item.linkedId === deleteId) {
                item.linkedId = null;
              }
            });

            await app.saveData();
            app.closeModal();
            app.renderList();
            app.showToast("已删除");
          }
        },

        updateFilterOptions: () => {
          const container = document.getElementById("filter-options-container");
          container.innerHTML = "";

          const allDiv = document.createElement("div");
          allDiv.className = `custom-option ${
            app.currentFilter === "All" ? "selected" : ""
          }`;
          allDiv.onclick = () => app.selectFilter("All");
          allDiv.innerHTML = `<span>显示全部</span><span class="check-icon">✓</span>`;
          container.appendChild(allDiv);

          const cats = [...new Set(app.data.map((i) => i.category))].sort();
          cats.forEach((c) => {
            const div = document.createElement("div");
            div.className = `custom-option ${
              app.currentFilter === c ? "selected" : ""
            }`;
            div.onclick = () => app.selectFilter(c);
            div.innerHTML = `<span>${app.escapeHtml(
              c
            )}</span><span class="check-icon">✓</span>`;
            container.appendChild(div);
          });
        },

        toggleFieldVisibility: (id) => {
          const el = document.getElementById(id);
          const isPwd = el.type === "password";
          el.type = isPwd ? "text" : "password";
          app.updatePwdIcon(!isPwd);
        },

        updatePwdIcon: (isVisible) => {
          const btn = document.getElementById("btn-pwd-toggle");
          if (!btn) return;
          if (isVisible) {
            btn.innerHTML = `<svg class="pwd-toggle-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
          } else {
            btn.innerHTML = `<svg class="pwd-toggle-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
          }
        },

        escapeHtml: (t) => {
          if (!t) return "";
          return String(t)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        },
      };

      app.init();
    </script>
  </body>
</html>
